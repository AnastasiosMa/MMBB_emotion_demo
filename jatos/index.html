<!DOCTYPE html>
<html>
  <head>


    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

    <meta charset="UTF-8">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="https://unpkg.com/jspsych@7.1.2"></script> 
    <!--<script src="./jspsych/dist/jspsych.js"> </script> -->

    <script src="./jspsych/dist/custom/utils.js"> </script>

    <script src="jatos.js"></script>

    <script src="./jspsych/dist/plugin-preload.js"> </script>
    <script src="./jspsych/dist/plugin-audio-button-response.js"></script>
    <script src="./jspsych/dist/plugin-html-button-response.js"></script>
    <script src="./jspsych/dist/plugin-html-slider-response.js"></script>
    <script src="./jspsych/dist/plugin-instructions.js"></script>
    <script src="./jspsych/dist/plugin-audio-keyboard-response.js"></script>
    <script src="./jspsych/dist/plugin-instructions-timedout.js"></script>
    <script src="./jspsych/dist/plugin-html-multi-slider-response.js"></script>
    <script src="./jspsych/dist/plugin-emotion-audio-button-response.js"> </script>
    <script src="./jspsych/dist/plugin-survey.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@0.2.1/css/survey.css"> 

    <!--<script src="./src/utils/langFetch.js"></script>
      <script src="./src/batteries/generalIntro.js"></script> -->
    <script src="./trials/trials.js"></script> 
    <script src="./src/utils/translations.js"></script>
    <script src="./src/utils/preventRefresh.js"> </script>
    <script src="./src/utils/identifyOS.js"> </script>
    <script src="./src/utils/manageCookies.js"> </script> 

    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.1.2/css/jspsych.css">

    <link rel="stylesheet" href="./src/styles/generalCSS.css">



  </head>

  <script>
  jatos.onLoad(() => {
    // FETCHES THE LANGUAGE
    var params = jatos.urlQueryParameters
    console.log(params)
    var lang = params.lang
    console.log(lang)
    if(lang === undefined){
      lang = "eng"
    }
    console.log(lang)

    // INITIATE JSPSYCH
    var jsPsych = initJsPsych({
      show_progress_bar: true,
        auto_update_progress_bar: false,
        on_finish: function() {
          allowRefresh()
          //jsPsych.data.get().localSave('csv','dataEmotion.csv'),
          //jatos.endStudy(jsPsych.data.get().json())
          jatos.submitResultData(jatos_data);
          jatos.endStudy()  
    }});

    // INTRO TRIALS
    var welcomePart1 = {
      type: jsPsychInstructions,
      pages: [emotionTranslations['openStatement'][lang]],
      button_label_next: buttons[0][lang],
      button_label_previous: buttons[1][lang],
      allow_backward: false,
      show_clickable_nav: true,
      on_finish: function(welcomePart1){
        jatos.appendResultData({'lang': lang})
        jatos_data.push({'lang': lang})
      }}
    
    var consent = {
      type: jsPsychInstructions,
      pages: [consent_form[0]],
      button_label_next: buttons[0][lang],
      button_label_previous: buttons[1][lang],
      allow_backward: false,
      show_clickable_nav: true,
    }

    var confirm_consent = {
      type: jsPsychHtmlButtonResponse,
      choices: ['I consent and agree to participate'],
      stimulus: consent_form[1],
    };
    
    var preloadTest = {
      type: jsPsychPreload,
      audio: ['./songs/movementTapAudio/elPesebre.mp3'],
      images: ['./images/muteButton.png'],
      auto_preload: false,
    }

    var tAudioIOS = {
      type: jsPsychAudioButtonResponse,
      stimulus: './songs/movementTapAudio/elPesebre.mp3',
      choices: [recurring[7][lang]],
      prompt: initialInstructions[0][4][lang] + '<img src="./images/muteButton.png" id="muteButton"></img>',
      on_load: function(){
        document.getElementById("jspsych-content").style.fontSize = "20px";
    }};

    var tAudioAndroid = {
      type: jsPsychAudioButtonResponse,
      stimulus: './songs/movementTapAudio/elPesebre.mp3',
      choices: [recurring[7][lang]],
      prompt: initialInstructions[0][4][lang],
      on_load: function(){
        document.getElementById("jspsych-content").style.fontSize = "20px";
    }};

    var testAudioIOS = {
      timeline: [tAudioIOS],
      conditional_function: function(){
        var OS = getMobileOperatingSystem()
        return (OS == "iOS" || OS == "unknown")
    }}

    var testAudioAndroid = {
        timeline: [tAudioAndroid],
        conditional_function: function(){
          var OS = getMobileOperatingSystem()
          return OS === "Android"
    }}

    var gettingHelp = {
      type: jsPsychHtmlButtonResponse,
      stimulus: initialInstructions[0][3][lang],
      choices: [initialInstructions[0][2][lang], initialInstructions[0][1][lang]],
      prompt: '',
      on_load: function(){
        document.getElementById("jspsych-html-button-response-btngroup").getElementsByClassName("jspsych-btn")[1].style.background = "purple"
    }};

    var generalIntroEmotion = [[preloadTest, testAudioIOS, testAudioAndroid, gettingHelp]];

    // PART1 VARIABLES
    var images = [
      { img: "./images/emotion/v1a5.png",  type: emotionTranslations['angry'][lang]},
      { img: "./images/emotion/v5a5.png",  type: emotionTranslations['happy'][lang]},
      { img: "./images/emotion/v1a1.png",  type: emotionTranslations['sad'][lang]},
      { img: "./images/emotion/v5a1.png",  type: emotionTranslations['tender'][lang]}
    ];
    
    var preload = {
      type: jsPsychPreload,
      images: ["./images/emotion/v1a5.png", "./images/emotion/v5a5.png","./images/emotion/v1a1.png","./images/emotion/v5a1.png"]
    }

    var emotions = ['angry','happy','sad','tender']
    var emotions_numeric = [1,2,3,4]
    var current_level = 1
    var previous_level  = []
    var epoch = 0
    var difficulty_change = 0.20
    var current_trial = []
    var current_emotion = []
    var excerpt_names = []
    var N = 30
    var N_part2 = 12
    var candidate_trial = []
    var correct_response = []
    var trial_images = []
    var excerpt_history = []
    var emotion_game_trials = 1
    var excerpts_played = []
    var jatos_data = []

    var emotion_order = []
    for (let i=0;i<N/emotions_numeric.length;i++) {
      emotion_order = emotion_order.concat(jsPsych.randomization.sampleWithoutReplacement(emotions_numeric,emotions_numeric.length))
    }
    console.log(emotion_order)   
    var excerpt_order = []
    for (let i=0;i<N;i++) {
      excerpt_order.push(jsPsych.randomization.sampleWithoutReplacement([0,1],2))
    }

    // PART 1 TRIALS
    var instructionsPart1 = {
      type: jsPsychInstructions,
      pages: emotionTranslations['instructions1'].map(i => i[lang]),
      button_label_next: buttons[0][lang],
      button_label_previous: buttons[1][lang],
      allow_backward: true,
      show_clickable_nav: true
    }
    var test_ending = {
      type: jsPsychInstructions,
      pages: emotionTranslations['instructions2'].map(i => i[lang]),
      button_label_next: buttons[0][lang],
      show_clickable_nav: true,
      allow_backward: false,
      on_start: function(test_ending){
        current_level = 1
        epoch = 0
    }}

    var trial_load_message = {
      type: jsPsychInstructionsTimedout,
      pages: ["<img id='logoLoading' src='./images/loading2.gif'>"],
      show_clickable_nav: false,
      trial_duration: 2000, 
      on_start: function(trial_load_message){
        //trial_load_message.pages = ["<img id='logoLoading' src='./images/loading2.gif'>"] 
      }}      

    var trial1 = {
      type: jsPsychEmotionAudioButtonResponse,
      stimulus: './songs/emotionAudio/trimmed_mp3/001.mp3',
      choices: [images[0]['img'], images[3]['img']],
      button_html: '<img src="%choice%" style="width: 110px" />',
      update_choices: '',
      update_text_after_timeout: emotionTranslations['choose'][lang],
      response_allowed_while_playing: false,
      response_ends_trial: true,
      update_onset: 10000,
      prompt: 'init',
      question: 'init',
      data: {},
      on_load: function(){
        document.querySelectorAll(".jspsych-audio-button-response-button").forEach(
          function(i) {
            i.style.fontSize = '16px'
          }
        )
        document.getElementById("jspsych-audio-button-response-btngroup").style.marginBottom = '60px'
        document.getElementById("id_prompt").style.fontSize = '18px'
      },
      on_start: function(trial1){
        console.log(epoch)
        current_emotion = emotions[emotion_order[epoch]-1]
        var level_trials = trials[String(current_level)][String(emotion_order[epoch])]
        candidate_trial = []
        for (let i=0;i<level_trials.length;i++) {
        if (!excerpts_played.includes(level_trials[i]['Name'])){
          candidate_trial.push(level_trials[i])
        }}
        if (candidate_trial.length > 0){
          console.log('In target')  
          current_trial = jsPsych.randomization.sampleWithoutReplacement(candidate_trial,1)[0]
        }
        else {
          level_trials = trials[String(current_level)]
          console.log('Out of target emotion')
          for (let i=1;i<5;i++) {
            for (let k=0;k<level_trials[i].length;k++) {
              if (!excerpts_played.includes(level_trials[i][k]['Name'])){
                candidate_trial.push(level_trials[i][k])
          }}}
          if (candidate_trial.length > 0){
            console.log('Early stopping')
            current_trial = jsPsych.randomization.sampleWithoutReplacement(candidate_trial,1)[0]
          } 
          else {
            jsPsych.endCurrentTimeline();
          }}
        excerpts_played[epoch] = current_trial['Name']
        excerpt_history[epoch] = current_trial['Label1'] 
        excerpt_names = [current_trial['Name']]
        trial_images = [current_trial['Label1'],current_trial['Label2']].sort();
        trial_track = excerpt_names[0]
        while (trial_track.length<3) {
          trial_track = '0' + trial_track
        }
        trial1.stimulus = './songs/emotionAudio/trimmed_mp3/' + trial_track + '.mp3'
        trial1.question = emotionTranslations["whichEmotion"][lang]
        trial1.prompt = emotionTranslations["listen"][lang]
        trial1.data.difficulty = current_trial['Distance']
        trial1.data.correct_emotion = emotions[current_trial['Label1']-1]
        trial1.data.wrong_emotion = emotions[current_trial['Label2']-1]
        trial1.data.trial_num = current_trial['Trials']
        trial1.data.level = current_level
        trial1.data.emotion_game_repeat = emotion_game_trials
        trial1.choices = [images[trial_images[0]-1], images[trial_images[1]-1]]
        trial1.update_choices = [images[trial_images[0]-1], images[trial_images[1]-1]]
        },
      on_finish: function(data){
        // Score the response as correct or incorrect.
        jsPsych.setProgressBar((epoch+1)/N)
        if(data.response == trial_images.findIndex(element => element == current_trial['Label1'])){
          correct_response = 1;
          data.correct_response = 1;
          data.epoch = epoch;
          previous_level = current_level
          jump_level = Math.ceil((16 - current_level)/(1/difficulty_change))
          current_level = current_level + jump_level
        }   
        else {
          correct_response = 0;
          data.correct_response = 0;
          data.epoch = epoch;
          previous_level = current_level
          jump_level = Math.ceil((current_level)/(1/difficulty_change))
          current_level = current_level - jump_level
          if(current_level == 0){
            current_level = 1
          }
        }
        epoch = epoch+1
        jatos.appendResultData(data)
        jatos_data.push(data)
    }}

    var part1_trials = {
      timeline: [trial_load_message,trial1],
      repetitions: N
    }

    var test = {
      timeline: [trial1, test_ending]
    }

    var task_repeat = {
      type: jsPsychInstructions,
      pages: [emotionTranslations['thankYouRepeat'][lang]],
      button_label_next: buttons[0][lang],
      show_clickable_nav: true,
      on_start: function(data){
        jsPsych.setProgressBar(0)
        epoch = 0
        current_level = 1
        emotion_game_trials = 2
        emotion_order = []
        for (let i=0;i<N/emotions_numeric.length;i++) {
        emotion_order = emotion_order.concat(jsPsych.randomization.sampleWithoutReplacement(emotions_numeric,emotions_numeric.length))
        }
        console.log(emotion_order)
        for (let i=0;i<N;i++) {
        excerpt_order.push(jsPsych.randomization.sampleWithoutReplacement([0,1],2))
    }}}  
    
    var messageFinishEmotion = {
      type: jsPsychHtmlButtonResponse,
      prompt: emotionTranslations['thankYouEnd'][lang],
      choices: [],
      trial_duration: 2000,
      stimulus: '',
      on_start: function(){
        document.cookie = "Emotion=done; path=/"
      }
    };

    var qAge = {
      type: 'text',
      prompt: emotionTranslations['howOld'][lang],
      placeholder: '',
      name: 'age', 
      textbox_columns: 5,
      textbox_rows: 1,
      required: true,
    }

    var qGender = {
      type: 'multi-choice',
      prompt: emotionTranslations['gender'][lang], 
      options: emotionTranslations['genderOptions'].map(i => i[lang]),
      name: 'gender', 
      required: true
    }

    var qHearingLoss = {
      type: 'multi-choice',
      prompt: emotionTranslations['hearingLoss'][lang], 
      options: emotionTranslations['hearingOptions'].map(i => i[lang]),
      name: 'hearingLoss', 
      required: true
    }

    var qFeedback = {
      type: 'text',
      prompt: emotionTranslations['feedbackAsk'][lang],
      placeholder: emotionTranslations['feedbackPlaceHolder'][lang],
      name: 'feedback', 
      textbox_columns: 30,
      textbox_rows: 7,
      required: false,
    }

    var howDifficult = {
      type: jsPsychHtmlSliderResponse,
      stimulus: recurring[9][lang],
      require_movement: false,
      labels: [recurring[10][lang], recurring[11][lang]],
      slider_width: 250,
      on_load: function(){
        document.getElementById("label0").style.fontSize = '20px'
        document.getElementById("label1").style.fontSize = '20px'
      },
      on_finish: function(data){
        jatos.appendResultData(data)
        jatos_data.push(data)
      }};

    var demographics = {
      type: jsPsychSurvey,
      pages: [[qAge], [qGender], [qHearingLoss], [qFeedback]],
      title: '',
      button_label_next: buttons[0][lang],
      button_label_back: buttons[1][lang],
      button_label_finish: buttons[0][lang],
      show_question_numbers: 'onPage',
      on_load: function(){
        document.querySelector(".sv_next_btn").style.background = "#fa6400";
        document.querySelector(".sv_prev_btn").style.background = "purple";
        document.querySelector(".sv_next_btn").style.color = "#fff";
        document.querySelector(".sv_prev_btn").style.color = "#fff";
        document.querySelector(".sv_complete_btn").style.background = "#fa6400";
      },
      on_finish: function(data){
        jatos.appendResultData(data)
        jatos_data.push(data)
      }
    };

    var procedureEmotionFinal = {
        timeline: [welcomePart1, consent, confirm_consent, generalIntroEmotion, instructionsPart1, preload, test, part1_trials, task_repeat, part1_trials, messageFinishEmotion, howDifficult,demographics].flat(1000),
        on_timeline_start: function() {
          console.log('This timeline has started');
        }
    }

    //jsPsych.run([procedureEmotionFinal])
    //jatos.onLoad(() => {
      jsPsych.run([procedureEmotionFinal]);
    //})
    })

 </script>

</html>
