<!DOCTYPE html>
<html>
  <head>
    <title>MMBB batery</title>
    <script src="./jspsych/dist/jspsych.js"> </script>
    <script src="./jspsych/dist/plugin-preload.js"> </script>
    <script src="./jspsych/dist/plugin-instructions.js"></script>
    <script src="./jspsych/dist/plugin-audio-keyboard-response.js"></script>
    <script src="./jspsych/dist/plugin-html-multi-slider-response.js"></script>
    <script src="./jspsych/dist/plugin-emotion-audio-button-response.js"> </script>
    <script src="./part1_adaptive/data/trials.js"> </script>
    <link href="https://unpkg.com/jspsych@7.2.1/css/jspsych.css" rel="stylesheet" type="text/css" /> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

  </head>
  <body></body>
  <script>

    var jsPsych = initJsPsych({
      show_progress_bar: true,
        auto_update_progress_bar: false,
        on_finish: function() {
          jsPsych.data.get().localSave('csv','dataEmotion.csv');
          //jatos.endStudy(jsPsych.data.get().json())
    }});
    //PART1
    var images = [
      { img: "./basic_emoji/v1a5.png",  type: 'Anger'},
      { img: "./basic_emoji/v5a5.png",  type: 'Happy'},
      { img: "./basic_emoji/v1a1.png",  type: 'Sad'},
      { img: "./basic_emoji/v5a1.png",  type: 'Tender'}
    ];
    
    var preload = {
    type: jsPsychPreload,
    auto_preload: true 
    }

    var emotions = ['angry','happy','sad','tender']
    var emotions_numeric = [1,2,3,4]
    var current_level = 1
    var previous_level  = []
    var epoch = 0
    var difficulty_change = 0.20
    var current_trial = []
    var current_emotion = []
    var excerpt_names = []
    var N = 16
    var N_part2 = 12
    var candidate_trial = []
    var correct_response = []
    var trial_images = []
    var excerpt_history = []

    var emotion_order = []
    for (let i=0;i<N/emotions_numeric.length;i++) {
      emotion_order = emotion_order.concat(jsPsych.randomization.sampleWithoutReplacement(emotions_numeric,emotions_numeric.length))
    }
    console.log(emotion_order)
    var excerpt_order = []
    for (let i=0;i<N;i++) {
      excerpt_order.push(jsPsych.randomization.sampleWithoutReplacement([0,1],2))
    }
    //trials 
    var instruction = {
      type: jsPsychInstructions,
      pages: ['<p style="font-size:6vw;">Emotion Battery</p>','<p style="font-size:30px;">Instructions</p>'+'<br>In this section, you will listen to short music'+
      ' tracks and asked to choose the emotion it mostly represents. The emotions in question are <strong>happy, sad, tender, </strong> and <strong>angry.</strong>'+
      ' Listen to the music track first and then make your choice.', '<p style="font-size:30px;"> Practice Trial</p>'+'<br>' +
      'You will now be presented with a trial to get familiar with the task. Your response will not be used in the analysis. <br>Please also adjust the volume to a comfortable level. '],
      button_label_next: "Next",
      button_label_previous: "Previous",
      allow_backward: true,
      show_clickable_nav: true
    }
    var test_ending = {
      type: jsPsychInstructions,
      pages: ['Thank you for your response! The trial is over, you can now start by clicking "Next"'],
      button_label_next: "Next",
      show_clickable_nav: true,
      allow_backward: true,
      on_start: function(test_ending){
        current_level = 2
        epoch = 0
    }}
    var trial1 = {
      type: jsPsychEmotionAudioButtonResponse,
      stimulus: 'part1_adaptive/trimmed_mp3/001.mp3',
      choices: [images[0]['img'], images[3]['img']],
      button_html: '<img src="%choice%" style="width: 150px" />',
      update_choices: '',
      response_allowed_while_playing: false,
      response_ends_trial: true,
      update_onset: 10000,
      prompt: 'init',
      question: 'init',
      data: {},
      on_start: function(trial1){ 
        current_emotion = emotions[emotion_order[epoch]-1]
        candidate_trial = trials[String(current_level)][String(emotion_order[epoch])]
        current_trial = jsPsych.randomization.sampleWithoutReplacement(candidate_trial,1)[0]
        console.log(current_trial)
        excerpt_history[epoch] = current_trial['Label1'] 
        excerpt_names = [current_trial['Name']]
        trial_images = [current_trial['Label1'],current_trial['Label2']].sort();
        trial_track = excerpt_names[0]
        while (trial_track.length<3) {
          trial_track = '0' + trial_track
        }
        trial1.stimulus = 'part1_adaptive/trimmed_mp3/' + trial_track + '.mp3'
        trial1.question = '<p style="font-size:25px;">Which of these two emotions does the music better represent?</p>'
        trial1.prompt = 'Listen to the music...'
        trial1.data.difficulty = current_trial['Distance']
        trial1.data.correct_emotion = emotions[current_trial['Label1']-1]
        trial1.data.wrong_emotion = emotions[current_trial['Label2']-1]
        //trial1.data.trial_index = current_trial['trial']
        trial1.data.level = current_level
        trial1.choices = [images[trial_images[0]-1], images[trial_images[1]-1]]
        trial1.update_choices = [images[trial_images[0]-1], images[trial_images[1]-1]]
        },
      on_finish: function(data){
        // Score the response as correct or incorrect.
        jsPsych.setProgressBar((epoch+1)/(N+N_part2))
        if(data.response == trial_images.findIndex(element => element == current_trial['Label1'])){
          correct_response = 1;
          trial1.data.correct_response = 1;
          previous_level = current_level
          jump_level = Math.ceil((16 - current_level)/(1/difficulty_change))
          current_level = current_level + jump_level
        }   
        else {
          correct_response = 0;
          trial1.data.correct_response = 0;
          previous_level = current_level
          jump_level = Math.ceil((current_level)/(1/difficulty_change))
          current_level = current_level - jump_level
          if(current_level == 0){
            current_level = 1
          }
        }
        epoch = epoch+1
      }};

    var feedback2 = {
      type: jsPsychInstructions,
      pages: ['<p style="font-size:30px;">Thank you for your response!</p> <br><br>To continue, click Next.'],
      button_label_next: "Next",
      show_clickable_nav: true,
      }      

    var feedback = {
      type: jsPsychInstructions,
      pages: [],
      button_label_next: "Next",
      show_clickable_nav: true,
      on_start: function(feedback){
        if(correct_response){
        feedback.pages = ['<p style="font-size:40px;">Correct!</p><p>Level ' + String(previous_level) + ' completed!' +
        '<br> Next level: ' + String(current_level) + '<br><br>' +
        'Trial Info: Correct Emotion: ' + emotions[current_trial['Label1']-1] + 
        ', Wrong Emotion: ' + emotions[current_trial['Label2']-1] + 
        ', Difficulty: ' + current_trial['Distance'] + 
        ', Epoch: ' + epoch + '</p>']
    } else {
      feedback.pages = ['<p style="font-size:40px;">Wrong!</p><p>Level ' + String(previous_level) + ' failed!' +
        '<br> Next level: ' + String(current_level) + '<br><br>' +
        'Trial Info: Correct Emotion: ' + emotions[current_trial['Label1']-1] + 
        ', Wrong Emotion: ' + emotions[current_trial['Label2']-1] + 
        ', Difficulty: ' + current_trial['Distance'] + 
        ', Epoch: ' + epoch + '</p>']
      }}}
      
    var part1_trials = {
      timeline: [trial1,feedback2],
      repetitions: N
    }

    var test = {
      timeline: [trial1, test_ending]
    }

    //PART2
    var stim_dur = 8200
    var part2_excerpts = ['091','010','093','026','077','055','037','078','088','052','028','041']
    var part2_excerpt_order = jsPsych.randomization.repeat(part2_excerpts,1)
    var epochPart2 = 0
    var instruction3 = {
        type: jsPsychInstructions,
        pages: [
        '<p style="font-size:7vw;">Emotion task Part 2</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    var instruction4 = {
        type: jsPsychInstructions,
        pages: [
        '<p style="font-size:30px;">Please rate the emotional content of the music</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    var part2_audio = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: 'part1_adaptive/trimmed_mp3/001.mp3',
        prompt: '<p style="font-size:30px;">Listen to the music</p>',
        trial_duration: stim_dur,
        choices: ["NO_KEYS"],
        on_start: function(part2_audio){
          part2_audio.stimulus = './part1_adaptive/trimmed_part2_mp3/' + part2_excerpt_order[epochPart2] + '.mp3'
        }
    }

    var part2_emotion_scales = {
    type: jsPsychHtmlMultiSliderResponse,
    stimulus: ['Mood', 'Energy', 'How strong are the emotions expressed by the music?'],
    nSliders: 3,
    require_movement: true,
    slider_width: 250,
    labels: [['Negative', 'Neutral','Positive'],['Low Energy', 'High Energy'],['Low intensity', 'High intensity']],
    prompt: 'Please rate the emotional content of the music'
    };
    
    var part2_other_scales = {
    type: jsPsychHtmlMultiSliderResponse,
    stimulus: ['How much did you like/dislike the music?','How familiar did the music sound to you?'],
    nSliders: 2,
    require_movement: true,
    slider_width: 250,
    labels: [['Strongly dislike','Neutral','Strongly like'],['Very unfamiliar','Very familiar']],
    on_finish: function(part2_other_scales){
      epochPart2 = epochPart2+1
      jsPsych.setProgressBar((epoch+epochPart2)/(N+N_part2))
    }
    };

    var part2_trials = {
        timeline: [part2_audio,part2_emotion_scales,part2_other_scales],
        repetitions: N_part2
      }
    
    var the_end = {
        type: jsPsychInstructions,
        pages: ['<p style="font-size:2vw;">The task is now complete! Thank you for your participation</p>'],
        button_label_next: "Next",
        show_clickable_nav: true,
      }  

    jsPsych.run([instruction, preload,test ,part1_trials, instruction3, instruction4, part2_trials,the_end]);
    //jsPsych.run([instruction3, instruction4, part2_trials,the_end]);


 </script>
</html>
