<!DOCTYPE html>
<html>
  <head>
    <title>Part1 adaptive</title>
    <script src="../jspsych/dist/graphFunction.js"> </script>
    <script src="../jspsych/dist/jspsych.js"></script>
    <script src="../jspsych/dist/plugin-audio-keyboard-response.js"></script>
    <script src="../jspsych/dist/plugin-html-button-response.js"> </script>
    <script src="../jspsych/dist/plugin-instructions.js"> </script>
    <script src="../jspsych/dist/plugin-emotion-audio-button-response.js"> </script>
    <script src="./data/trials.js"> </script>
    <link href="https://unpkg.com/jspsych@7.2.1/css/jspsych.css" rel="stylesheet" type="text/css" /> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

  </head>
  <body></body>
  <script>
      var jsPsych = initJsPsych({
        show_progress_bar: true,
        auto_update_progress_bar: false,
        on_finish: function() {
          jsPsych.data.get().localSave('csv','dataEmoENGPart1.csv');
          //jatos.endStudy(jsPsych.data.get().json())
        }
      });

      var images = [
      { img: "../basic_emoji/v1a5.png",  type: 'Anger'},
      { img: "../basic_emoji/v5a5.png",  type: 'Happy'},
      { img: "../basic_emoji/v1a1.png",  type: 'Sad'},
      { img: "../basic_emoji/v5a1.png",  type: 'Tender'}
    ];
    var images_blurred = [
      { img: "../basic_emoji/v1a5.png",  type: 'Anger'},
      { img: "../basic_emoji/v5a5.png",  type: 'Happy'},
      { img: "../basic_emoji/v1a1.png",  type: 'Sad'},
      { img: "../basic_emoji/v5a1.png",  type: 'Tender'}
    ];

      var emotions = ['angry','happy','sad','tender']
      var emotions_numeric = [1,2,3,4]
      var current_level = 1
      var epoch = 0
      var current_trial = []
      var current_emotion = []
      var excerpt_names = []
      var N = 16
      var candidate_trial = []
      var correct_response = []
      var trial_images = []
      var excerpt_history = []

      var emotion_order = []
      for (let i=0;i<N/emotions_numeric.length;i++) {
        emotion_order = emotion_order.concat(jsPsych.randomization.sampleWithoutReplacement(emotions_numeric,emotions_numeric.length))
      }

      var excerpt_order = []
      for (let i=0;i<N;i++) {
        excerpt_order.push(jsPsych.randomization.sampleWithoutReplacement([0,1],2))
      }
      //trials 
      var instruction = {
          type: jsPsychInstructions,
          pages: ['<p style="font-size:6vw;">Emotion game v6.</p>','<p style="font-size:30px;">Instructions</p>'+'<br>In this section, you will listen to short music'+
        ' tracks and asked to choose the emotion it mostly represents. The emotions in question are <strong>happy, sad, tender, angry, </strong> and <strong>fearful.</strong>'+
        ' Listen to the music track first and then make your choice.', '<p style="font-size:30px;">Trial</p>'+'<br>' +
        'You will now be presented with a trial to get familiar with the task. Your response will not be used in the analysis. Please also adjust the volume to a comfortable level. '],
          button_label_next: "Next",
          button_label_previous: "Previous",
          show_clickable_nav: true
      }
      var test_ending = {
          type: jsPsychInstructions,
          pages: ['Thank you for your response! The trial is over, you can now start by clicking "Next"'],
          button_label_next: "Next",
          show_clickable_nav: true
      }
      var trial1 = {
          type: jsPsychEmotionAudioButtonResponse,
          stimulus: 'init',
          choices: [images[0]['img'], images[3]['img']],
          button_html: '<img src="%choice%" style="width: 150px" />',
          update_choices: '',
          response_allowed_while_playing: false,
          response_ends_trial: true,
          update_onset: 10000,
          prompt: 'init',
          question: 'init',
          data: {},
          on_start: function(trial1){ 

          current_emotion = emotions[emotion_order[epoch]-1]
          candidate_trial = trials[String(current_level)][String(emotion_order[epoch])]
          current_trial = jsPsych.randomization.sampleWithoutReplacement(candidate_trial,1)[0]
          excerpt_history[epoch] = current_trial['Label1'] 
          excerpt_names = [current_trial['Name']]
          trial_images = [current_trial['Label1'],current_trial['Label2']].sort();
          trial_track = excerpt_names[0]
          while (trial_track.length<3) {
            trial_track = '0' + trial_track
          }
          trial1.stimulus = 'trimmed_mp3/' + trial_track + '.mp3'
          trial1.question = '<p style="font-size:25px;">Which emotion does this music represent?</p>'
          trial1.prompt = 'Listen to the music...'
          trial1.data.difficulty = current_trial['Distance']
          trial1.data.correct_emotion = emotions[current_trial['Label1']-1]
          trial1.data.wrong_emotion = emotions[current_trial['Label2']-1]
          //trial1.data.trial_index = current_trial['trial']
          trial1.data.level = current_level
          trial1.choices = [images_blurred[trial_images[0]-1], images_blurred[trial_images[1]-1]]
          trial1.update_choices = [images[trial_images[0]-1], images[trial_images[1]-1]]
      },
        on_finish: function(data){
          // Score the response as correct or incorrect.
          jsPsych.setProgressBar((epoch+1)/N)
          if(data.response == trial_images.findIndex(element => element == current_trial['Label1'])){
            correct_response = 1;
            trial1.data.correct_response = 1;
          }   
          else {
            correct_response = 0;
            trial1.data.correct_response = 0;
          }
        }};

      var feedback = {
        type: jsPsychInstructions,
        pages: [],
        button_label_next: "Next",
        show_clickable_nav: true,
        on_start: function(feedback){
          current_level = current_level+1
          epoch = epoch+1
          if(correct_response){
          feedback.pages = ['<p style="font-size:40px;">Correct!</p><p>Level ' + String(current_level-1) + ' completed!' +
          '<br> Next level: ' + String(current_level) + '<br><br>' +
          'Trial Info: Correct Emotion: ' + emotions[current_trial['Label1']-1] + 
          ', Wrong Emotion: ' + emotions[current_trial['Label2']-1] + 
          ', Difficulty: ' + current_trial['Distance'] + '</p>']
      } else {
        feedback.pages = ['<p style="font-size:40px;">Wrong!</p><p>Level ' + String(current_level-1) + ' failed!' +
          '<br> Next level: ' + String(current_level) + '<br><br>' +
          'Trial Info: Correct Emotion: ' + emotions[current_trial['Label1']-1] + 
          ', Wrong Emotion: ' + emotions[current_trial['Label2']-1] + 
          ', Difficulty: ' + current_trial['Distance'] + '</p>']
        }}}
      
      var the_end = {
        type: jsPsychInstructions,
        pages: ['<p style="font-size:2vw;">The task is now complete! Thank you for your participation</p>'],
        button_label_next: "Next",
        show_clickable_nav: true,
      }  

      var test = {
        timeline: [trial1, test_ending]
      }

      var node = {
        timeline: [trial1,feedback],
        repetitions: N
      }
      
      //jatos.onLoad(() => {
        //jatos.addAbortButton();
        jsPsych.run([instruction, test, node, the_end]);
      //})

 </script>
</html>
